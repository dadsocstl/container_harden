FROM repo1.dso.mil/dsop/redhat/ubi/8.x/ubi8-micro:latest

LABEL maintainer="DoD Container Security Team" \
      description="STL Cyber - Lightweight Container Hardening & Compliance Suite (DoD Environment)" \
      version="2025.1" \
      org.opencontainers.image.title="Container Security Scanner - DoD Lightweight Edition" \
      org.opencontainers.image.description="Lightweight container security scanning assuming pre-installed tools (SAF, Docker, Trivy)" \
      org.opencontainers.image.authors="3290178" \
      org.opencontainers.image.source="https://github.com/dadsocstl/container_harden"

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    DOCKER_HOST=unix:///var/run/docker.sock \
    PATH="/usr/local/bin:/usr/bin:/bin:/app"

# Install minimal system dependencies only
RUN microdnf install -y \
    bash \
    curl \
    wget \
    git \
    jq \
    python3 \
    python3-pip \
    ca-certificates \
    && microdnf clean all

# NOTE: The following tools MUST be available in the environment:
# - Trivy (vulnerability scanner) - any version
# - Docker/Podman client - any version  
# - MITRE SAF CLI (for HDF reports) - any version
#
# These can be installed system-wide, in user PATH, or mounted from host
# The container will use whatever version is available

# Create application directory
WORKDIR /app

# Copy all necessary files
COPY improved.sh /app/
COPY convert_tbl_to_html.py /app/
COPY trivy_to_nist.py /app/
COPY osi_approved_licenses.txt /app/
COPY country_software_origins.txt /app/
COPY container_hardening.hdf.json /app/
COPY generate_html_reports.sh /app/
COPY license-table.tpl /app/
COPY html.tpl /app/
COPY UNIFIED_COMPLIANCE_CSV_REFERENCE.md /app/

# Make scripts executable
RUN chmod +x /app/improved.sh /app/convert_tbl_to_html.py /app/trivy_to_nist.py /app/generate_html_reports.sh

# Create directories for outputs and cache
RUN mkdir -p /app/logs /app/results /app/trivy_db

# Copy entrypoint script
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Set entrypoint
ENTRYPOINT ["/app/entrypoint.sh"]

# Default command (shows usage)
CMD []

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD [ -f /app/improved.sh ] || exit 1

# Metadata
VOLUME ["/results"]
EXPOSE 0